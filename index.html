<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carpe Diem – Stock Simulator</title>
  <style>
    :root{
      --bg:#0b132b;
      --panel:#14213d;
      --card:#1b294a;
      --accent:#4cafef;
      --accent-2:#357abd;
      --text:#ffffff;
      --muted:#eef4ff;
      --muted-2:#d7e3ff;
      --good:#3ddc97;
      --bad:#ff6b6b;
      --border:#ffffff33;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      background:var(--bg); color:var(--text);
    }
    header{
      background:linear-gradient(90deg,#0e1a34,#18335f);
      padding:14px 16px; text-align:center; font-weight:800; letter-spacing:.3px;
      box-shadow:0 2px 14px #0008;
    }
    .wrap{max-width:1160px;margin:24px auto;padding:0 16px}
    .hidden{display:none !important}
    .panel{
      background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:0 6px 24px #0006;
    }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:0 4px 18px #0005;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:10px; border:1px solid transparent;
      font-weight:700; cursor:pointer; transition:.18s ease;
    }
    .btn-primary{ background:var(--accent); color:#041426 }
    .btn-primary:hover{ background:var(--accent-2) }
    .btn-ghost{ background:transparent; border-color:var(--border); color:var(--text) }
    .btn-ghost:hover{ background:#ffffff14 }
    /* Login */
    .login-shell{ min-height:70vh; display:grid; place-items:center; }
    .login-box{ width:min(480px,100%); padding:28px }
    .input{
      width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--border); background:#0e1a34; color:#fff;
    }
    .input::placeholder{ color:#f0f5ff }
    label{ font-size:.9rem; color:var(--muted); margin-bottom:6px; display:inline-block }
    /* Grid */
    .grid{ display:grid; gap:16px }
    .grid-3{ grid-template-columns:repeat(3,1fr) }
    @media (max-width:960px){ .grid-3{ grid-template-columns:repeat(2,1fr) } }
    @media (max-width:640px){ .grid-3{ grid-template-columns:1fr } }
    /* Stock tiles */
    .tile{
      padding:12px; border-radius:12px; border:1px solid var(--border); background:#0f1c37;
      cursor:pointer; transition:transform .12s ease, border-color .12s ease;
    }
    .tile:hover{ transform:translateY(-1px); border-color:#ffffff55 }
    .tile .name{ font-weight:800; color:#fff }
    .tile .price{ color:#fff; margin-top:2px; font-weight:800 }
    /* Metrics row */
    .metrics{ display:grid; grid-template-columns:repeat(3,1fr); gap:14px }
    @media (max-width:700px){ .metrics{ grid-template-columns:1fr } }
    .metric{
      padding:14px; border-radius:12px; border:1px solid var(--border); background:#0f1c37; text-align:center;
    }
    .metric .label{ font-size:.85rem; color:var(--muted-2); letter-spacing:.02em }
    .metric .value{ font-size:1.6rem; font-weight:800; margin-top:6px; color:#fff }
    /* Details */
    .details{ display:grid; grid-template-columns:2fr 1fr; gap:16px }
    @media (max-width:900px){ .details{ grid-template-columns:1fr } }
    canvas{ width:100%; height:220px; background:#0b1730; border:1px solid var(--border); border-radius:12px }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .spacer{ flex:1 }
    .muted{ color:var(--muted) }
    hr.sep{ border:none; height:1px; background:var(--border); margin:10px 0 }
    table{ width:100%; border-collapse:separate; border-spacing:0 8px }
    th,td{ text-align:left; padding:8px 10px; color:#fff }
    th{ color:#e9f1ff; font-weight:800; border-bottom:1px solid var(--border) }
    tr.data{ background:#0f1c37; border:1px solid var(--border) }
    tr.data td{ border-top:1px solid var(--border); border-bottom:1px solid var(--border) }
    small.err{ color:#ffd0d0 }
  </style>
</head>
<body>
  <header>Carpe Diem – Stock Simulator</header>

  <main class="wrap">
    <!-- LOGIN -->
    <section id="loginSection" class="panel login-shell">
      <form id="loginForm" class="login-box card">
        <h2 style="margin:0 0 14px 0">Sign in</h2>
        <div class="grid">
          <div>
            <label for="email">Email</label>
            <input id="email" type="email" class="input" placeholder="name@gsis.ac.in" required />
          </div>
          <div>
            <label for="password">Password</label>
            <input id="password" type="password" class="input" placeholder="••••••••" required />
          </div>
          <div class="row" style="margin-top:4px">
            <button id="loginBtn" class="btn btn-primary" type="submit">Log in</button>
            <span id="loginError" class="muted" style="margin-left:8px"></span>
          </div>
        </div>
      </form>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="hidden">
      <div class="panel" style="padding:12px 14px; display:flex; align-items:center; gap:10px; flex-wrap:wrap">
        <strong id="roleHeader">Welcome</strong>
        <span class="spacer"></span>
        <button id="logoutBtn" class="btn btn-ghost">Log out</button>
      </div>

      <!-- Trader metrics -->
      <div id="traderMetrics" class="metrics" style="margin:16px 0" hidden>
        <div class="metric">
          <div class="label">Working Capital</div>
          <div class="value">₹<span id="workingCap">0.00</span></div>
        </div>
        <div class="metric">
          <div class="label">Invested Capital</div>
          <div class="value">₹<span id="investedCap">0.00</span></div>
        </div>
        <div class="metric">
          <div class="label">Profit / Loss</div>
          <div class="value" id="profitLoss">0.00%</div>
        </div>
      </div>

      <!-- Stocks -->
      <div class="panel" style="padding:16px">
        <div class="row" style="margin-bottom:10px">
          <h3 style="margin:0">Stocks</h3>
          <span class="spacer"></span>
        </div>
        <div id="stockList" class="grid grid-3"></div>
      </div>

      <!-- Details + Admin -->
      <section class="details" style="margin-top:16px">
        <!-- Left: stock chart + trade (trader only) -->
        <div class="panel" style="padding:16px">
          <div class="row">
            <h3 id="detailName" style="margin:0">Select a stock</h3>
            <span class="spacer"></span>
            <div id="detailPrice" class="muted"></div>
          </div>
          <canvas id="chart" width="900" height="220"></canvas>
          <div id="tradeBar" class="row" style="margin-top:10px">
            <label for="qty" class="muted">Qty</label>
            <input id="qty" class="input" type="number" min="1" value="1" style="width:120px" />
            <button id="buyBtn" class="btn btn-primary">Buy</button>
            <button id="sellBtn" class="btn btn-ghost">Sell</button>
            <span id="tradeMsg" class="muted"></span>
          </div>
          <div id="autoRow" class="row" style="margin-top:10px">
            <label for="autoPrice" class="muted">Auto-sell at price</label>
            <input id="autoPrice" class="input" type="number" min="0" placeholder="e.g. 1200" style="width:160px" />
            <input id="autoQty" class="input" type="number" min="1" placeholder="qty" style="width:120px" />
            <button id="setAutoBtn" class="btn btn-primary">Set Auto-Sell</button>
            <button id="clearAutoBtn" class="btn btn-ghost">Clear</button>
            <span id="autoMsg" class="muted"></span>
          </div>
        </div>

        <!-- Right: Admin controls -->
        <div class="panel" style="padding:16px">
          <h3 style="margin-top:0">Admin</h3>
          <div id="adminOnlyHint" class="muted">Only visible for admins</div>

          <div id="adminControls" class="hidden">
            <div class="row">
              <label class="muted">Adjust selected stock</label>
            </div>
            <div class="row">
              <button id="raiseBtn" class="btn btn-primary">Increase 10%</button>
              <button id="lowerBtn" class="btn btn-ghost">Decrease 10%</button>
            </div>
            <hr class="sep" />
            <div class="row">
              <label class="muted">Set starting funds for ALL traders</label>
            </div>
            <div class="row">
              <input id="allFunds" class="input" type="number" min="0" placeholder="e.g. 100000" style="width:180px" />
              <button id="applyFundsBtn" class="btn btn-primary">Apply</button>
              <span id="fundsMsg" class="muted"></span>
            </div>
            <hr class="sep" />
            <div class="row">
              <button id="resetBtn" class="btn btn-ghost" style="color:var(--bad);font-weight:800">⚠ Hard Reset</button>
            </div>
            <hr class="sep" />
            <h4 style="margin:6px 0">Trader Rankings</h4>
            <div id="rankWrap" class="card" style="padding:10px; max-height:260px; overflow:auto">
              <table>
                <thead>
                  <tr><th>#</th><th>Trader</th><th>Total Equity</th><th>P/L</th></tr>
                </thead>
                <tbody id="rankTable"></tbody>
              </table>
            </div>
            <div id="portfolioWrap" class="card" style="padding:10px; margin-top:10px; display:none">
              <h4 id="pfTitle" style="margin:6px 0">Portfolio</h4>
              <div class="row muted" id="pfSummary"></div>
              <table style="margin-top:6px">
                <thead><tr><th>Stock</th><th>Qty</th><th>Price</th><th>Value</th></tr></thead>
                <tbody id="pfTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import {
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged,
      setPersistence, browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs,
      onSnapshot, query, where, deleteDoc
    } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyC72GZrrjG4UIR3qzDs-I2QWIgSFd4Yehs",
      authDomain: "carpediem-f6948.firebaseapp.com",
      projectId: "carpediem-f6948",
      storageBucket: "carpediem-f6948.firebasestorage.app",
      messagingSenderId: "705608113463",
      appId: "1:705608113463:web:eb70088734b33486c70eb2"
    };
    const APP_ID = "carpe_diem";
    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db = getFirestore(app);

    await setPersistence(auth, browserSessionPersistence);
    try{ await signOut(auth); }catch(e){}

    const $ = (id)=>document.getElementById(id);

    const dashboard = $("dashboard");
    const loginSection = $("loginSection");
    const loginForm = $("loginForm");
    const loginBtn = $("loginBtn");
    const loginError = $("loginError");
    const logoutBtn = $("logoutBtn");
    const roleHeader = $("roleHeader");

    const stockList = $("stockList");
    const detailName = $("detailName");
    const detailPrice = $("detailPrice");
    const chartEl = $("chart");
    const tradeMsg = $("tradeMsg");
    const tradeBar = $("tradeBar");

    const raiseBtn = $("raiseBtn");
    const lowerBtn = $("lowerBtn");
    const resetBtn = $("resetBtn");
    const allFunds = $("allFunds");
    const applyFundsBtn = $("applyFundsBtn");
    const fundsMsg = $("fundsMsg");
    const rankTable = $("rankTable");
    const pfTitle = $("pfTitle");
    const pfSummary = $("pfSummary");
    const pfTable = $("pfTable");
    const portfolioWrap = $("portfolioWrap");
    const adminControls = $("adminControls");
    const adminOnlyHint = $("adminOnlyHint");

    let me=null,myRole=null,selectedId=null,stocks={},myTrader=null,series=[],lastSampleTime=0;
    let chartCtx=chartEl.getContext("2d");

    const SEED_STOCKS=["Reliance Industries","TCS","Infosys","HDFC Bank","ICICI Bank","SBI","Bharti Airtel"];

    const TICK_MS=3000;
    function clamp(n){return Math.max(1,Number.isFinite(n)?n:0);}
    function currentPriceFor(s){return s?.price??s?.baseline??500;}
    function jumpOnce(s){let base=s.baseline??500;let mag=0.01+Math.random()*0.02;let sign=Math.random()<0.5?-1:1;s.price=Math.round(base*(1+sign*mag)*100)/100;}

    onAuthStateChanged(auth,async user=>{
      if(!user){loginSection.classList.remove("hidden");dashboard.classList.add("hidden");return;}
      me=user;
      const roleDoc=await getDoc(doc(db,"artifacts",APP_ID,"public","data","roles",user.uid));
      myRole=roleDoc.exists()?roleDoc.data().role:"trader";
      roleHeader.textContent=`Welcome, ${myRole}`;
      adminControls.classList.toggle("hidden",myRole!=="admin");
      adminOnlyHint.classList.toggle("hidden",myRole==="admin");
      tradeBar.classList.toggle("hidden",myRole==="admin");
      loginSection.classList.add("hidden");dashboard.classList.remove("hidden");
      bootstrapStocks();attachRealtime();
      setInterval(()=>Object.values(stocks).forEach(s=>jumpOnce(s)),TICK_MS);
      if(myRole==="admin") loadRankingsLoop();
    });

    loginForm.addEventListener("submit",async e=>{
      e.preventDefault();loginBtn.disabled=true;
      try{await signInWithEmailAndPassword(auth,$("email").value,$("password").value);}
      catch(err){loginError.textContent=err.message;}
      finally{loginBtn.disabled=false;}
    });
    logoutBtn.onclick=()=>signOut(auth);

    async function bootstrapStocks(){
      const col=collection(db,"artifacts",APP_ID,"public","data","stocks");
      const snap=await getDocs(col);
      if(snap.empty&&myRole==="admin"){
        for(let name of SEED_STOCKS){
          await setDoc(doc(col,name.toLowerCase().replace(/\s+/g,"_")),{
            name,baseline:500+Math.random()*200,price:500
          });
        }
      }
    }

    function attachRealtime(){
      onSnapshot(collection(db,"artifacts",APP_ID,"public","data","stocks"),snap=>{
        snap.forEach(docSnap=>{
          stocks[docSnap.id]=docSnap.data();
        });
        renderStocks();
      });
    }

    function renderStocks(){
      stockList.innerHTML="";
      Object.entries(stocks).forEach(([id,s])=>{
        let div=document.createElement("div");
        div.className="tile";div.innerHTML=`<div class="name">${s.name}</div><div class="price">₹${currentPriceFor(s).toFixed(2)}</div>`;
        div.onclick=()=>{selectedId=id;detailName.textContent=s.name;detailPrice.textContent=`₹${currentPriceFor(s).toFixed(2)}`;};
        stockList.appendChild(div);
      });
    }

    async function adjustSelected(mult){
      if(!selectedId) return;
      let ref=doc(db,"artifacts",APP_ID,"public","data","stocks",selectedId);
      let snap=await getDoc(ref);
      if(snap.exists()){
        let s=snap.data();
        let newBase=(s.baseline??s.price??500)*mult;
        await updateDoc(ref,{baseline:newBase,price:newBase});
      }
    }
    raiseBtn.onclick=()=>adjustSelected(1.1);
    lowerBtn.onclick=()=>adjustSelected(0.9);

    async function hardReset(){
      if(!confirm("Reset ALL trader data and stocks?")) return;
      const stocksCol=collection(db,"artifacts",APP_ID,"public","data","stocks");
      const stocksSnap=await getDocs(stocksCol);
      for(let d of stocksSnap.docs){
        await updateDoc(d.ref,{baseline:500,price:500});
      }
      const tradersCol=collection(db,"artifacts",APP_ID,"public","data","traders");
      const tradersSnap=await getDocs(tradersCol);
      for(let d of tradersSnap.docs){
        await deleteDoc(d.ref);
      }
      alert("System reset complete.");
    }
    resetBtn.onclick=hardReset;

    async function setFundsAll(){
      let amt=Number(allFunds.value);
      if(!amt) return;
      const tradersCol=collection(db,"artifacts",APP_ID,"public","data","traders");
      const tradersSnap=await getDocs(tradersCol);
      for(let d of tradersSnap.docs){
        await updateDoc(d.ref,{funds:amt});
      }
      fundsMsg.textContent="Funds applied!";
    }
    applyFundsBtn.onclick=setFundsAll;

    async function loadRankingsLoop(){
      setInterval(async ()=>{
        const tradersCol=collection(db,"artifacts",APP_ID,"public","data","traders");
        const tradersSnap=await getDocs(tradersCol);
        let arr=[];
        tradersSnap.forEach(d=>arr.push({...d.data(),id:d.id}));
        arr.sort((a,b)=>(b.funds??0)-(a.funds??0));
        rankTable.innerHTML=arr.map((t,i)=>`<tr><td>${i+1}</td><td>${t.id}</td><td>₹${(t.funds??0).toFixed(2)}</td><td>${t.pl??0}%</td></tr>`).join("");
      },3000);
    }
  </script>
</body>
</html>
